cmake_minimum_required(VERSION 3.0.1)
project(MonoAlg3D)

MACRO(USE_C99)
    IF (CMAKE_VERSION VERSION_LESS "3.1")
        IF (CMAKE_C_COMPILER_ID STREQUAL "GNU")
            SET(CMAKE_C_FLAGS "-std=gnu99 ${CMAKE_C_FLAGS}")
        ENDIF(CMAKE_C_COMPILER_ID)
    ELSE()
        SET(CMAKE_C_STANDARD 99)
    ENDIF()
ENDMACRO(USE_C99)

USE_C99()

SET( CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/bin )
SET( CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/shared_libs )

IF(EXISTS "/etc/manjaro-release")
    set(CMAKE_C_COMPILER "/opt/cuda/bin/gcc")
ENDIF(EXISTS "/etc/manjaro-release")

SET (CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -fno-strict-aliasing -Wall -Wno-unused-function")

FIND_PACKAGE(OpenMP)
IF (OPENMP_FOUND)
    set (CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${OpenMP_C_FLAGS}")
    set (CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${OpenMP_CXX_FLAGS}")
    set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} ${OpenMP_EXE_LINKER_FLAGS}")
ENDIF()

FIND_PACKAGE(CUDA)
IF (CUDA_FOUND)
    SET (CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -I ${CUDA_INCLUDE_DIRS} -DCOMPILE_CUDA")
    SET (CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -I ${CUDA_INCLUDE_DIRS} -DCOMPILE_CUDA")
    ADD_SUBDIRECTORY(src/gpu_utils)
    SET(OPT_DEPS gpu_utils)

ENDIF()

FIND_PACKAGE(OpenGL)
FIND_PACKAGE(GLUT)
IF(OPENGL_FOUND AND GLUT_FOUND)
    SET (CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -I ${OPENGL_INCLUDE_DIR} -I ${GLUT_INCLUDE_DIR} -DCOMPILE_OPENGL")
    SET (CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -I ${OPENGL_INCLUDE_DIR} -I ${GLUT_INCLUDE_DIR} -DCOMPILE_OPENGL")
    ADD_SUBDIRECTORY(src/draw)
    SET(OPT_DEPS ${OPT_DEPS} draw)
ENDIF()

ADD_SUBDIRECTORY(src/utils)
ADD_SUBDIRECTORY(src/alg)
ADD_SUBDIRECTORY(src/monodomain)
ADD_SUBDIRECTORY(src/hash)
ADD_SUBDIRECTORY(src/ini_parser)
ADD_SUBDIRECTORY(src/string)

ADD_EXECUTABLE(MonoAlg3D src/main.c)

ADD_DEPENDENCIES(MonoAlg3D utils alg solvers hashes ini_parser string ${OPT_DEPS})

TARGET_LINK_LIBRARIES(MonoAlg3D alg solvers utils hashes ini_parser string ${OPT_DEPS} ${OPENGL_LIBRARIES} ${GLUT_LIBRARIES} ${CUDA_LIBRARIES} dl m)

ADD_SUBDIRECTORY(src/models_library)
ADD_SUBDIRECTORY(src/stimuli_library)
ADD_SUBDIRECTORY(src/domains_library)
ADD_SUBDIRECTORY(src/extra_data_library)

SET( CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/tests_bin )

ADD_SUBDIRECTORY(src/tests)
